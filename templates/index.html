<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF MCQ Generator-sathish</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .upload-container {
            border: 2px dashed #ccc;
            padding: 20px;
            text-align: center;
            margin: 20px 0;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 2s linear infinite;
            margin: 20px auto;
            display: none; /* Hidden by default */
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #statusMessages {
            margin: 20px 0;
            text-align: center;
        }
        .status-message {
            margin: 10px 0;
            padding: 15px;
            border-radius: 4px;
            font-size: 16px;
            font-weight: bold;
            display: none;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status-message.info {
            background-color: #e3f2fd;
            color: #1976d2;
            border: 1px solid #bbdefb;
        }
        .status-message.success {
            background-color: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #c8e6c9;
        }
        .status-message.error {
            background-color: #ffebee;
            color: #c62828;
            border: 1px solid #ffcdd2;
        }

        /* Upload Progress Bar Styling */
        #uploadProgressContainer {
            display: none;
            margin: 20px 0;
            text-align: center;
        }

        #uploadProgressLabel {
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }

        #uploadProgressBar {
            width: 100%;
            height: 30px;
            background-color: #f0f0f0;
            border-radius: 15px;
            overflow: hidden;
            border: 2px solid #4CAF50;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        #uploadProgressFill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #45a049);
            width: 0%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
        }

        #uploadProgressText {
            margin-top: 10px;
            color: #666;
            font-size: 14px;
        }

        /* Custom Model Configuration Styling */
        #customModelConfig {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
        }

        #customModelConfig input {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ccc;
            border-radius: 3px;
            box-sizing: border-box;
        }

        select, input[type="number"] {
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ccc;
            border-radius: 3px;
        }

        /* Summary Box Styling */
        .summary-box {
            background-color: #f0f8ff;
            border: 2px solid #4CAF50;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
        }

        .summary-section {
            margin: 15px 0;
            padding: 10px;
            background-color: white;
            border-radius: 5px;
        }

        .summary-section h3 {
            color: #2e7d32;
            margin-top: 0;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 5px;
        }

        .page-distribution, .section-distribution {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin: 10px 0;
        }

        .distribution-item {
            background-color: #e8f5e9;
            padding: 8px;
            border-radius: 4px;
            text-align: center;
            border: 1px solid #c8e6c9;
        }

        .distribution-item strong {
            color: #1b5e20;
        }

        .question {
            background-color: #fafafa;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid #4CAF50;
        }

        .question-metadata {
            background-color: #fff3e0;
            padding: 8px;
            margin: 8px 0;
            border-radius: 4px;
            font-size: 0.9em;
            border-left: 3px solid #ff9800;
        }

        .metadata-badge {
            display: inline-block;
            background-color: #ff9800;
            color: white;
            padding: 3px 8px;
            border-radius: 3px;
            margin: 2px;
            font-size: 0.85em;
        }
    </style>
</head>
<body>
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <h1 style="margin: 0;">PDF MCQ Generator-sathish</h1>
        <div style="display: flex; align-items: center; gap: 15px;">
            <span style="color: #666; font-size: 14px;">üë§ {{ current_user.username }}</span>
            <a href="{{ url_for('logout') }}" style="background-color: #f44336; color: white; padding: 8px 16px; text-decoration: none; border-radius: 5px; font-size: 14px; font-weight: bold;">üö™ Logout</a>
        </div>
    </div>

    <!-- Mode Selector -->
    <div style="background-color: #f0f0f0; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
        <label style="font-weight: bold; margin-right: 20px;">
            <input type="radio" name="mode" value="generate" checked onchange="switchMode('generate')">
            ü§ñ Generate New MCQs from PDF Content
        </label>
        <label style="font-weight: bold; margin-right: 20px;">
            <input type="radio" name="mode" value="parse" onchange="switchMode('parse')">
            üìã Parse Existing MCQ PDF
        </label>
        <label style="font-weight: bold; margin-right: 20px;">
            <input type="radio" name="mode" value="split" onchange="switchMode('split')">
            ‚úÇÔ∏è Split PDF File
        </label>
        <label style="font-weight: bold;">
            <input type="radio" name="mode" value="summarize" onchange="switchMode('summarize')">
            üìù Generate Notes
        </label>
    </div>

    <div class="upload-container">
        <form id="uploadForm" enctype="multipart/form-data">
            <label for="pdfFile" style="font-weight: bold;">üìÑ Upload Base PDF Document:</label>
            <input type="file" id="pdfFile" name="pdfFile" accept=".pdf" required>
            <p style="font-size: 0.85em; color: #d32f2f; margin: 10px 0;">
                ‚ö†Ô∏è <strong>Production Limit:</strong> Maximum 6MB per upload on Vercel. For larger files, please use the local version or contact support.
            </p>
            <br>

            <!-- Amendment PDF Upload -->
            <div style="background-color: #fff3cd; padding: 15px; border-radius: 5px; margin: 15px 0;">
                <label style="font-weight: bold;">
                    <input type="checkbox" id="useAmendment" name="useAmendment" onchange="toggleAmendmentUpload()">
                    üìù Generate questions from PDF with amendments
                </label>
                <p style="font-size: 0.9em; color: #666; margin: 10px 0;">
                    Enable this to upload an amendment PDF and generate questions covering changes, differences, and new provisions.
                </p>

                <div id="amendmentUploadSection" style="display: none; margin-top: 10px;">
                    <label for="amendmentPdfFile" style="font-weight: bold;">üìã Upload Amendment PDF:</label>
                    <input type="file" id="amendmentPdfFile" name="amendmentPdfFile" accept=".pdf">
                    <p style="font-size: 0.85em; color: #666; margin-top: 5px;">
                        ‚ÑπÔ∏è Questions will analyze both documents and focus on amendments, changes, and differences.
                    </p>
                    <div id="amendmentFileInfo" style="margin-top: 10px; padding: 10px; background-color: #e7f3ff; border-radius: 3px; display: none;">
                        <strong>‚úÖ Amendment PDF loaded:</strong> <span id="amendmentFileName"></span>
                    </div>
                </div>
            </div>

            <!-- Generate Mode Section -->
            <div id="generateModeSection">
                <label for="questionCount">Number of Questions:</label>
                <input type="number" id="questionCount" name="questionCount" min="1" max="100" value="5">
                <br>
                <input type="checkbox" id="useMaxQuestions" name="useMaxQuestions">
                <label for="useMaxQuestions">üöÄ Generate Maximum Questions (ignores number above)</label>
                <br><br>
                <label for="difficulty">Difficulty Level:</label>
                <select id="difficulty" name="difficulty">
                    <option value="easy">Easy</option>
                    <option value="medium" selected>Medium</option>
                    <option value="hard">Hard</option>
                </select>
                <br><br>
            </div>

            <!-- Parse Mode Section -->
            <div id="parseModeSection" style="display: none;">
                <label for="answerPage">Answer Key Page Number (default: last page):</label>
                <input type="number" id="answerPage" name="answerPage" min="-1" value="-1">
                <p style="font-size: 0.9em; color: #666;">Use -1 for last page, or enter the page number (1-indexed)</p>
                <br>
            </div>

            <!-- Split Mode Section -->
            <div id="splitModeSection" style="display: none;">
                <label for="splitMode" style="font-weight: bold;">Split Method:</label>
                <select id="splitMode" name="splitMode" onchange="updateSplitOptions()">
                    <option value="pages_per_file" selected>Split by Pages Per File</option>
                    <option value="page_ranges">Split by Page Ranges</option>
                    <option value="individual_pages">Split into Individual Pages</option>
                </select>
                <br><br>

                <!-- Pages Per File Option -->
                <div id="pagesPerFileOption">
                    <label for="pagesPerFile">Number of Pages Per File:</label>
                    <input type="number" id="pagesPerFile" name="pagesPerFile" min="1" value="5" placeholder="e.g., 5">
                    <p style="font-size: 0.9em; color: #666;">Each split file will contain this many pages (except possibly the last one)</p>
                    <br>
                </div>

                <!-- Page Ranges Option -->
                <div id="pageRangesOption" style="display: none;">
                    <label for="pageRanges">Page Ranges (comma-separated):</label>
                    <input type="text" id="pageRanges" name="pageRanges" placeholder="e.g., 1-5, 6-10, 11-15">
                    <p style="font-size: 0.9em; color: #666;">Specify ranges as start-end (1-indexed). Example: 1-5, 6-10, 11-15</p>
                    <br>
                </div>

                <!-- Individual Pages Option -->
                <div id="individualPagesOption" style="display: none;">
                    <p style="font-size: 0.9em; color: #666; background-color: #e3f2fd; padding: 10px; border-radius: 4px;">
                        ‚ÑπÔ∏è Each page will be saved as a separate PDF file. This is useful for organizing large documents.
                    </p>
                    <br>
                </div>
            </div>

            <!-- Book and Chapter Information -->
            <label for="bookName">Book Name (optional):</label>
            <input type="text" id="bookName" name="bookName" placeholder="e.g., Introduction to Computer Science">
            <br><br>
            <label for="chapterName">Chapter Name (optional):</label>
            <input type="text" id="chapterName" name="chapterName" placeholder="e.g., Chapter 5: Data Structures">
            <br><br>
            <!-- AI Model Configuration -->
            <label for="modelProvider">AI Model Provider:</label>
            <select id="modelProvider" name="modelProvider" onchange="updateModelOptions()">
                <option value="openrouter" selected>OpenRouter</option>
                <option value="openai">OpenAI</option>
                <option value="anthropic">Anthropic</option>
                <option value="deepseek">DeepSeek</option>
                <option value="custom">Custom Model</option>
            </select>
            <br><br>

            <!-- Model Selection -->
            <label for="modelName">Model:</label>
            <select id="modelName" name="modelName">
                <option value="openrouter/cypher-alpha:free" selected>Cypher Alpha (Free)</option>
                <option value="openrouter/anthropic/claude-2:free">Claude 2 (Free)</option>
            </select>
            <br><br>

            <!-- Custom Model Configuration (hidden by default) -->
            <div id="customModelConfig" style="display: none;">
                <label for="customModelName">Custom Model Name:</label>
                <input type="text" id="customModelName" name="customModelName" placeholder="e.g., gpt-4, claude-3-opus">
                <br><br>
                <label for="customApiKey">API Key:</label>
                <input type="password" id="customApiKey" name="customApiKey" placeholder="Enter your API key">
                <br><br>
                <label for="customBaseUrl">Base URL (optional):</label>
                <input type="text" id="customBaseUrl" name="customBaseUrl" placeholder="e.g., https://api.openai.com/v1">
                <br><br>
            </div>
            <br><br>
            <button type="submit" id="submitButton">Generate MCQs</button>
        </form>
    </div>

    <!-- Split PDF Results Section -->
    <div id="splitResultContainer" style="display: none;">
        <h2>‚úÇÔ∏è PDF Split Results:</h2>
        <div style="background-color: #e8f5e9; padding: 15px; border-radius: 5px; margin: 15px 0;">
            <p id="splitMessage" style="color: #2e7d32; font-weight: bold;"></p>
            <p style="color: #666; font-size: 0.9em;">
                <strong>Total Pages:</strong> <span id="totalPages"></span> |
                <strong>Split Files:</strong> <span id="splitCount"></span>
            </p>
        </div>

        <h3>üì• Download Split Files:</h3>
        <div id="splitFilesContainer" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; margin: 15px 0;">
            <!-- Split files will be listed here -->
        </div>
    </div>

    <!-- PDF Summary Results Section -->
    <div id="summaryResultContainer" style="display: none;">
        <h2>üìù Comprehensive Academic Notes:</h2>
        <div style="background-color: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <div style="margin-bottom: 15px; padding: 10px; background-color: #e3f2fd; border-radius: 5px;">
                <p style="color: #666; font-size: 0.9em; margin: 5px 0; display: inline-block; margin-right: 20px;">
                    <strong>üìÑ File:</strong> <span id="summaryFilename"></span>
                </p>
                <p style="color: #666; font-size: 0.9em; margin: 5px 0; display: inline-block; margin-right: 20px;">
                    <strong>üìñ Pages:</strong> <span id="summaryTotalPages"></span>
                </p>
                <p style="color: #666; font-size: 0.9em; margin: 5px 0; display: inline-block; margin-right: 20px;">
                    <strong>üìä Characters:</strong> <span id="summaryTextLength"></span>
                </p>
                <p style="color: #666; font-size: 0.9em; margin: 5px 0; display: inline-block;">
                    <strong>ü§ñ Model:</strong> <span id="summaryModelUsed"></span>
                </p>
            </div>
            <div id="summaryText" style="background-color: #fff; padding: 25px; border-radius: 5px; border: 1px solid #e0e0e0; font-size: 1em; line-height: 1.8; color: #333; max-height: 600px; overflow-y: auto; white-space: pre-wrap; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;"></div>
        </div>
        <div style="margin-top: 15px;">
            <button onclick="copySummary()" style="background-color: #1976d2; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 1em; margin-right: 10px;">
                üìã Copy Notes
            </button>
            <button onclick="downloadNotes()" style="background-color: #4CAF50; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 1em;">
                üì• Download as Text
            </button>
        </div>
    </div>

    <!-- Add status messages before the loader -->
    <div id="statusMessages">
        <div id="uploadStatus" class="status-message info">üì§ Uploading your PDF file...</div>
        <div id="extractStatus" class="status-message info">üìÑ Extracting text from PDF...</div>
        <div id="generateStatus" class="status-message info">‚öôÔ∏è Generating MCQ questions...</div>
    </div>

    <!-- Real-time progress messages for streaming -->
    <div id="progressStream" style="display: none; background: linear-gradient(135deg, #f5f7fa 0%, #e4e8ec 100%); border-radius: 10px; padding: 20px; margin: 20px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
        <h3 style="margin: 0 0 15px 0; color: #333;">üìä Generation Progress</h3>
        <div id="progressMessagesList" style="max-height: 300px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 14px;">
        </div>
    </div>

    <!-- Upload Progress Bar -->
    <div id="uploadProgressContainer">
        <div id="uploadProgressLabel">üì§ Uploading PDF...</div>
        <div id="uploadProgressBar">
            <div id="uploadProgressFill">0%</div>
        </div>
        <div id="uploadProgressText">0 MB / 0 MB</div>
    </div>

    <div class="loader" id="loader"></div>

    <!-- Questions Section (appears first) -->
    <div id="resultContainer" style="display: none;">
        <h2>Generated Questions:</h2>
        <div id="questionsOutput"></div>
    </div>

    <!-- Summary Section (appears below questions) -->
    <div id="summaryContainer" style="display: none; margin-top: 20px;">
        <h2>üìä Question Distribution Summary</h2>
        <div id="summaryOutput" class="summary-box"></div>
    </div>

    <!-- Download buttons -->
    <div id="downloadContainer" style="display: none; margin-top: 20px;">
        <button id="downloadCsvButton" onclick="downloadCSV()">Download as CSV</button>
        <button id="downloadPdfButton" onclick="downloadPDF()">Download as PDF</button>
    </div>
    
    <!-- Update the script section by adding these functions -->
    <script>
        let currentQuestions = null;
        let currentPdfSummary = null;

        // Model configurations
        // Note: Free models on OpenRouter change frequently - some may become unavailable
        // Updated: Feb 2026 based on OpenRouter free models collection
        const modelConfigs = {
            openrouter: [
                // ‚≠ê Most Reliable - DeepSeek V3 (Recommended)
                { value: 'deepseek/deepseek-chat', text: '‚≠ê DeepSeek V3 - Most Reliable (Recommended)' },
                { value: 'deepseek/deepseek-r1-0528:free', text: 'DeepSeek R1 0528 (Free) - Reasoning Model' },

                // üî• Arcee AI Models (Frontier)
                { value: 'arcee-ai/trinity-large-preview:free', text: 'üî• Arcee Trinity Large Preview (Free) - 400B Frontier' },
                { value: 'arcee-ai/trinity-mini:free', text: 'Arcee Trinity Mini (Free) - 26B Efficient' },

                // Meta Llama Models
                { value: 'meta-llama/llama-3.3-70b-instruct:free', text: 'Llama 3.3 70B (Free) - High Quality' },

                // Qwen Models
                { value: 'qwen/qwen3-235b-a22b-instruct:free', text: 'Qwen3 235B (Free) - High Performance' },
                { value: 'qwen/qwen3-coder:free', text: 'Qwen3 Coder 480B (Free) - Code Expert' },

                // NVIDIA Models
                { value: 'nvidia/nemotron-nano-9b-v2:free', text: 'NVIDIA Nemotron Nano 9B (Free) - Fast' },
                { value: 'nvidia/nemotron-3-nano-30b-a3b:free', text: 'NVIDIA Nemotron 3 Nano 30B (Free) - Efficient' },

                // OpenAI Open Source
                { value: 'openai/gpt-oss-20b:free', text: 'OpenAI GPT-OSS 20B (Free) - Lightweight' },
                { value: 'openai/gpt-oss-120b:free', text: 'OpenAI GPT-OSS 120B (Free) - High Quality' },

                // Other Free Models
                { value: 'stepfun/step-3.5-flash:free', text: 'StepFun Step 3.5 Flash (Free) - Fast' },
                { value: 'z-ai/glm-4.5-air:free', text: 'Z.ai GLM 4.5 Air (Free) - Agent Optimized' },
                { value: 'upstage/solar-pro-3:free', text: 'Upstage Solar Pro 3 (Free) - Korean/English' },
                { value: 'microsoft/phi-3-medium-128k-instruct:free', text: 'Phi-3 Medium 128K (Free) - Long Context' },
                { value: 'mistralai/mistral-7b-instruct:free', text: 'Mistral 7B (Free) - Efficient' },

                // Limited Rate Models (Use with caution)
                { value: 'google/gemini-2.0-flash-exp:free', text: 'Gemini 2.0 Flash (Free) - ‚ö†Ô∏è 4 req/min only' }
            ],
            openai: [
                { value: 'gpt-3.5-turbo', text: 'GPT-3.5 Turbo' },
                { value: 'gpt-4', text: 'GPT-4' },
                { value: 'gpt-4-turbo', text: 'GPT-4 Turbo' },
                { value: 'gpt-4o', text: 'GPT-4o' }
            ],
            anthropic: [
                { value: 'claude-3-haiku-20240307', text: 'Claude 3 Haiku' },
                { value: 'claude-3-sonnet-20240229', text: 'Claude 3 Sonnet' },
                { value: 'claude-3-opus-20240229', text: 'Claude 3 Opus' }
            ],
            deepseek: [
                { value: 'deepseek-chat', text: 'DeepSeek Chat' },
                { value: 'deepseek-coder', text: 'DeepSeek Coder' }
            ]
        };

        function updateModelOptions() {
            const provider = document.getElementById('modelProvider').value;
            const modelSelect = document.getElementById('modelName');
            const customConfig = document.getElementById('customModelConfig');

            // Clear existing options
            modelSelect.innerHTML = '';

            if (provider === 'custom') {
                // Show custom model configuration
                customConfig.style.display = 'block';
                modelSelect.style.display = 'none';
            } else {
                // Hide custom model configuration
                customConfig.style.display = 'none';
                modelSelect.style.display = 'block';

                // Populate model options
                const models = modelConfigs[provider] || [];
                models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.value;
                    option.textContent = model.text;
                    modelSelect.appendChild(option);
                });
            }
        }

        // Mode switching function
        function switchMode(mode) {
            const generateSection = document.getElementById('generateModeSection');
            const parseSection = document.getElementById('parseModeSection');
            const splitSection = document.getElementById('splitModeSection');
            const submitButton = document.getElementById('submitButton');
            const amendmentSection = document.getElementById('amendmentUploadSection');
            const useAmendment = document.getElementById('useAmendment');

            if (mode === 'generate') {
                generateSection.style.display = 'block';
                parseSection.style.display = 'none';
                splitSection.style.display = 'none';
                submitButton.textContent = 'Generate MCQs';
                useAmendment.parentElement.parentElement.style.display = 'block';
            } else if (mode === 'parse') {
                generateSection.style.display = 'none';
                parseSection.style.display = 'block';
                splitSection.style.display = 'none';
                submitButton.textContent = 'Parse MCQ PDF';
                useAmendment.parentElement.parentElement.style.display = 'none';
            } else if (mode === 'split') {
                generateSection.style.display = 'none';
                parseSection.style.display = 'none';
                splitSection.style.display = 'none';
                submitButton.textContent = 'Split PDF';
                useAmendment.parentElement.parentElement.style.display = 'none';
                splitSection.style.display = 'block';
            } else if (mode === 'summarize') {
                generateSection.style.display = 'none';
                parseSection.style.display = 'none';
                splitSection.style.display = 'none';
                submitButton.textContent = 'Generate Notes';
                useAmendment.parentElement.parentElement.style.display = 'none';
            }
        }

        // Update split options based on selected method
        function updateSplitOptions() {
            const splitMode = document.getElementById('splitMode').value;
            const pagesPerFileOption = document.getElementById('pagesPerFileOption');
            const pageRangesOption = document.getElementById('pageRangesOption');
            const individualPagesOption = document.getElementById('individualPagesOption');

            // Hide all options first
            pagesPerFileOption.style.display = 'none';
            pageRangesOption.style.display = 'none';
            individualPagesOption.style.display = 'none';

            // Show selected option
            if (splitMode === 'pages_per_file') {
                pagesPerFileOption.style.display = 'block';
            } else if (splitMode === 'page_ranges') {
                pageRangesOption.style.display = 'block';
            } else if (splitMode === 'individual_pages') {
                individualPagesOption.style.display = 'block';
            }
        }

        // Toggle amendment PDF upload section
        function toggleAmendmentUpload() {
            const useAmendment = document.getElementById('useAmendment').checked;
            const amendmentSection = document.getElementById('amendmentUploadSection');
            const amendmentFile = document.getElementById('amendmentPdfFile');

            if (useAmendment) {
                amendmentSection.style.display = 'block';
            } else {
                amendmentSection.style.display = 'none';
                amendmentFile.value = '';
                document.getElementById('amendmentFileInfo').style.display = 'none';
            }
        }

        // Handle amendment file selection
        document.addEventListener('DOMContentLoaded', function() {
            updateModelOptions();

            const amendmentFile = document.getElementById('amendmentPdfFile');
            if (amendmentFile) {
                amendmentFile.addEventListener('change', function() {
                    const fileInfo = document.getElementById('amendmentFileInfo');
                    const fileName = document.getElementById('amendmentFileName');

                    if (this.files && this.files[0]) {
                        fileName.textContent = this.files[0].name;
                        fileInfo.style.display = 'block';
                    } else {
                        fileInfo.style.display = 'none';
                    }
                });
            }
        });
    
        function displaySummary(summary) {
            const summaryContainer = document.getElementById('summaryContainer');
            const summaryOutput = document.getElementById('summaryOutput');

            if (!summary) {
                summaryContainer.style.display = 'none';
                return;
            }

            let summaryHtml = `
                <div class="summary-section">
                    <h3>üìà Overview</h3>
                    <p><strong>Total Questions:</strong> ${summary.total_questions}</p>
                    <p><strong>Total Pages:</strong> ${summary.total_pages}</p>
                    <p><strong>Sections Detected:</strong> ${summary.total_sections}</p>
                    <p><strong>Coverage:</strong> ${summary.coverage_percentage.toFixed(1)}% of pages (${summary.pages_with_questions.length}/${summary.total_pages} pages)</p>
                </div>
            `;

            // Page distribution
            if (Object.keys(summary.page_distribution).length > 0) {
                summaryHtml += `
                    <div class="summary-section">
                        <h3>üìÑ Questions per Page</h3>
                        <div class="page-distribution">
                `;

                for (const [page, count] of Object.entries(summary.page_distribution).sort((a, b) => a[0] - b[0])) {
                    summaryHtml += `
                        <div class="distribution-item">
                            <strong>Page ${page}</strong><br>
                            ${count} question${count > 1 ? 's' : ''}
                        </div>
                    `;
                }

                summaryHtml += `
                        </div>
                    </div>
                `;
            }

            // Section distribution
            if (Object.keys(summary.section_distribution).length > 0) {
                summaryHtml += `
                    <div class="summary-section">
                        <h3>üìö Questions per Section</h3>
                        <div class="section-distribution">
                `;

                for (const [section, count] of Object.entries(summary.section_distribution).sort((a, b) => b[1] - a[1])) {
                    summaryHtml += `
                        <div class="distribution-item">
                            <strong>${section}</strong><br>
                            ${count} question${count > 1 ? 's' : ''}
                        </div>
                    `;
                }

                summaryHtml += `
                        </div>
                    </div>
                `;
            }

            // Pages without questions
            if (summary.pages_without_questions && summary.pages_without_questions.length > 0) {
                summaryHtml += `
                    <div class="summary-section">
                        <h3>‚ö†Ô∏è Pages Without Questions</h3>
                        <p>${summary.pages_without_questions.join(', ')}</p>
                    </div>
                `;
            }

            summaryOutput.innerHTML = summaryHtml;
            summaryContainer.style.display = 'block';
        }

        function displayParseSummary(summary) {
            const summaryContainer = document.getElementById('summaryContainer');
            const summaryOutput = document.getElementById('summaryOutput');

            if (!summary) {
                summaryContainer.style.display = 'none';
                return;
            }

            let summaryHtml = `
                <div class="summary-section">
                    <h3>üìä Parsing Summary</h3>
                    <p><strong>Total Questions Extracted:</strong> ${summary.total_questions}</p>
                    <p><strong>Total Pages:</strong> ${summary.total_pages}</p>
                    <p><strong>Answer Key Page:</strong> ${summary.answer_page + 1}</p>
                    <p><strong>Questions with Answers:</strong> ${summary.questions_with_answers}</p>
                    ${summary.questions_without_answers > 0 ? `<p style="color: #ff9800;"><strong>‚ö†Ô∏è Questions without answers:</strong> ${summary.questions_without_answers}</p>` : ''}
                </div>
            `;

            summaryOutput.innerHTML = summaryHtml;
            summaryContainer.style.display = 'block';
        }

        function displayQuestions(questions) {
            const questionsOutput = document.getElementById('questionsOutput');
            questionsOutput.innerHTML = '';

            questions.forEach((q, index) => {
                // Build metadata display
                let metadataHtml = '';
                if (q.metadata) {
                    const pages = q.metadata.pages || [];
                    const sections = q.metadata.sections || [];

                    if (pages.length > 0 || sections.length > 0) {
                        metadataHtml = '<div class="question-metadata">';
                        metadataHtml += '<strong>üìç Source:</strong> ';

                        if (pages.length > 0) {
                            metadataHtml += `<span class="metadata-badge">Page${pages.length > 1 ? 's' : ''}: ${pages.join(', ')}</span> `;
                        }

                        if (sections.length > 0) {
                            sections.forEach(section => {
                                metadataHtml += `<span class="metadata-badge">${section}</span> `;
                            });
                        }

                        metadataHtml += '</div>';
                    }
                }

                const questionHtml = `
                    <div class="question">
                        <p><strong>Question ${index + 1}:</strong> ${q.text || q.question}</p>
                        ${metadataHtml}
                        <p>A) ${q.options.A}</p>
                        <p>B) ${q.options.B}</p>
                        <p>C) ${q.options.C}</p>
                        <p>D) ${q.options.D}</p>
                        <p><strong>Correct Answer:</strong> ${q.correct}</p>
                        <p><strong>Difficulty:</strong> ${q.difficulty}</p>
                        <p><strong>Explanation:</strong> ${q.explanation}</p>
                        <hr>
                    </div>
                `;
                questionsOutput.innerHTML += questionHtml;
            });
        }
    
        function downloadCSV() {
            if (!currentQuestions) return;

            // Prepare data with PDF summary
            const csvData = {
                questions: currentQuestions,
                pdf_summary: currentPdfSummary
            };

            fetch('/download-csv', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(csvData)
            })
            .then(response => response.blob())
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'mcq_questions.csv';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while downloading the CSV file');
            });
        }
    
        function downloadPDF() {
            if (!currentQuestions) {
                alert('No questions available to download');
                return;
            }

            fetch('/download-pdf', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(currentQuestions)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.blob();
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = 'mcq_questions.pdf';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
            })
            .catch(error => {
                console.error('Error downloading PDF:', error);
                alert('Error downloading PDF. Please try again.');
            });
        }

        function displaySplitResults(data) {
            const splitResultContainer = document.getElementById('splitResultContainer');
            const splitMessage = document.getElementById('splitMessage');
            const totalPages = document.getElementById('totalPages');
            const splitCount = document.getElementById('splitCount');
            const filesContainer = document.getElementById('splitFilesContainer');

            // Update summary information
            splitMessage.textContent = data.message;
            totalPages.textContent = data.total_pages;
            splitCount.textContent = data.split_count;

            // Clear previous files
            filesContainer.innerHTML = '';

            // Display each split file with download button
            data.files.forEach((file, index) => {
                const fileCard = document.createElement('div');
                fileCard.style.cssText = `
                    background-color: #f5f5f5;
                    border: 1px solid #ddd;
                    border-radius: 5px;
                    padding: 15px;
                    text-align: center;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                `;

                const fileName = document.createElement('p');
                fileName.style.cssText = 'font-weight: bold; margin: 0 0 10px 0; word-break: break-word;';
                fileName.textContent = file.filename;

                const fileSize = document.createElement('p');
                fileSize.style.cssText = 'color: #666; font-size: 0.9em; margin: 0 0 10px 0;';
                fileSize.textContent = `Size: ${file.size}`;

                const downloadBtn = document.createElement('a');
                downloadBtn.href = `/download-split-pdf/${data.session_id}/${encodeURIComponent(file.filename)}`;
                downloadBtn.style.cssText = `
                    display: inline-block;
                    background-color: #4CAF50;
                    color: white;
                    padding: 10px 15px;
                    text-decoration: none;
                    border-radius: 4px;
                    font-weight: bold;
                    cursor: pointer;
                    transition: background-color 0.3s;
                `;
                downloadBtn.textContent = 'üì• Download';
                downloadBtn.onmouseover = function() { this.style.backgroundColor = '#45a049'; };
                downloadBtn.onmouseout = function() { this.style.backgroundColor = '#4CAF50'; };

                fileCard.appendChild(fileName);
                fileCard.appendChild(fileSize);
                fileCard.appendChild(downloadBtn);
                filesContainer.appendChild(fileCard);
            });

            // Show the results container
            splitResultContainer.style.display = 'block';
        }

        function displaySummaryResults(data) {
            const summaryResultContainer = document.getElementById('summaryResultContainer');
            const summaryText = document.getElementById('summaryText');
            const summaryFilename = document.getElementById('summaryFilename');
            const summaryTotalPages = document.getElementById('summaryTotalPages');
            const summaryTextLength = document.getElementById('summaryTextLength');
            const summaryModelUsed = document.getElementById('summaryModelUsed');

            // Update summary information
            summaryText.textContent = data.summary;
            summaryFilename.textContent = data.filename;
            summaryTotalPages.textContent = data.total_pages;
            summaryTextLength.textContent = data.text_length.toLocaleString();
            summaryModelUsed.textContent = data.model_used;

            // Show the results container
            summaryResultContainer.style.display = 'block';
        }

        function copySummary() {
            const summaryText = document.getElementById('summaryText').textContent;
            navigator.clipboard.writeText(summaryText).then(function() {
                alert('Notes copied to clipboard!');
            }).catch(function(err) {
                console.error('Failed to copy: ', err);
                alert('Failed to copy notes. Please select and copy manually.');
            });
        }

        function downloadNotes() {
            const summaryText = document.getElementById('summaryText').textContent;
            const filename = document.getElementById('summaryFilename').textContent || 'notes';
            const blob = new Blob([summaryText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename.replace('.pdf', '') + '_notes.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        document.getElementById('uploadForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const fileInput = document.getElementById('pdfFile');
            const file = fileInput.files[0];

            // Get current mode
            const mode = document.querySelector('input[name="mode"]:checked').value;

            const loader = document.getElementById('loader');
            const resultContainer = document.getElementById('resultContainer');
            const summaryContainer = document.getElementById('summaryContainer');
            const downloadContainer = document.getElementById('downloadContainer');
            const questionsOutput = document.getElementById('questionsOutput');
            const summaryOutput = document.getElementById('summaryOutput');

            // Status message elements
            const uploadStatus = document.getElementById('uploadStatus');
            const extractStatus = document.getElementById('extractStatus');
            const generateStatus = document.getElementById('generateStatus');

            function showStatus(element) {
                // Hide all status messages first
                [uploadStatus, extractStatus, generateStatus].forEach(el => el.style.display = 'none');
                // Show the current status
                element.style.display = 'block';
            }

            if (file) {
                // Check file size - Vercel has a 6MB limit for serverless functions
                const MAX_FILE_SIZE_PRODUCTION = 6 * 1024 * 1024; // 6MB for production (Vercel limit)
                const MAX_FILE_SIZE_LOCAL = 500 * 1024 * 1024; // 500MB for local

                // Detect if running on Vercel (production)
                const isProduction = window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1';
                const maxFileSize = isProduction ? MAX_FILE_SIZE_PRODUCTION : MAX_FILE_SIZE_LOCAL;

                if (file.size > maxFileSize) {
                    const maxSizeMB = (maxFileSize / (1024 * 1024)).toFixed(1);
                    const fileSizeMB = (file.size / (1024 * 1024)).toFixed(1);
                    const environment = isProduction ? 'production (Vercel)' : 'local';
                    alert(`‚ùå File too large!\n\nYour file: ${fileSizeMB}MB\nMaximum allowed on ${environment}: ${maxSizeMB}MB\n\nPlease use a smaller PDF or try the local version for larger files.`);
                    return;
                }

                // Reset display
                loader.style.display = 'block';
                resultContainer.style.display = 'none';
                summaryContainer.style.display = 'none';
                downloadContainer.style.display = 'none';
                document.getElementById('splitResultContainer').style.display = 'none';
                document.getElementById('summaryResultContainer').style.display = 'none';
                questionsOutput.innerHTML = '';
                summaryOutput.innerHTML = '';

                // Show initial upload status
                showStatus(uploadStatus);

                const formData = new FormData();
                formData.append('pdfFile', file);

                // Determine endpoint and form data based on mode
                let endpoint = '/upload';
                let useStreaming = false;

                if (mode === 'parse') {
                    endpoint = '/parse-mcq';
                    formData.append('answerPage', document.getElementById('answerPage').value);
                } else if (mode === 'split') {
                    endpoint = '/split-pdf';
                    formData.append('splitMode', document.getElementById('splitMode').value);
                    formData.append('pagesPerFile', document.getElementById('pagesPerFile').value);
                    formData.append('pageRanges', document.getElementById('pageRanges').value);
                } else if (mode === 'summarize') {
                    endpoint = '/summarize-pdf';
                    formData.append('modelProvider', document.getElementById('modelProvider').value);
                    // Use DeepSeek V3 by default for summarization (reliable free model)
                    const provider = document.getElementById('modelProvider').value;
                    if (provider === 'openrouter') {
                        formData.append('modelType', 'deepseek/deepseek-chat');
                    } else {
                        formData.append('modelType', document.getElementById('modelSelect').value || 'deepseek/deepseek-chat');
                    }
                } else {
                    // Generate mode - use streaming endpoint for real-time progress
                    useStreaming = true;
                    endpoint = '/upload-stream';
                    formData.append('questionCount', document.getElementById('questionCount').value);
                    formData.append('difficulty', document.getElementById('difficulty').value);
                    formData.append('modelProvider', document.getElementById('modelProvider').value);
                    formData.append('bookName', document.getElementById('bookName').value);
                    formData.append('chapterName', document.getElementById('chapterName').value);
                    formData.append('useMaxQuestions', document.getElementById('useMaxQuestions').checked);

                    // Handle model selection
                    const provider = document.getElementById('modelProvider').value;
                    if (provider === 'custom') {
                        formData.append('modelName', document.getElementById('customModelName').value);
                        formData.append('customApiKey', document.getElementById('customApiKey').value);
                        formData.append('customBaseUrl', document.getElementById('customBaseUrl').value);
                    } else {
                        formData.append('modelName', document.getElementById('modelName').value);
                    }
                }

                const progressContainer = document.getElementById('uploadProgressContainer');
                const progressFill = document.getElementById('uploadProgressFill');
                const progressText = document.getElementById('uploadProgressText');
                const progressStream = document.getElementById('progressStream');
                const progressMessagesList = document.getElementById('progressMessagesList');

                // Function to add progress message
                function addProgressMessage(message, isError = false) {
                    const msgDiv = document.createElement('div');
                    msgDiv.style.padding = '8px 12px';
                    msgDiv.style.marginBottom = '5px';
                    msgDiv.style.borderRadius = '5px';
                    msgDiv.style.backgroundColor = isError ? '#ffebee' : '#e8f5e9';
                    msgDiv.style.borderLeft = `4px solid ${isError ? '#f44336' : '#4CAF50'}`;
                    msgDiv.style.color = isError ? '#c62828' : '#2e7d32';
                    msgDiv.textContent = message;
                    progressMessagesList.appendChild(msgDiv);
                    progressMessagesList.scrollTop = progressMessagesList.scrollHeight;
                }

                if (useStreaming) {
                    // Use fetch with streaming for generate mode
                    progressStream.style.display = 'block';
                    progressMessagesList.innerHTML = '';
                    addProgressMessage('üöÄ Starting MCQ generation...');

                    // Hide old status messages
                    document.getElementById('statusMessages').style.display = 'none';

                    fetch(endpoint, {
                        method: 'POST',
                        body: formData
                    }).then(response => {
                        const reader = response.body.getReader();
                        const decoder = new TextDecoder();

                        function readStream() {
                            reader.read().then(({done, value}) => {
                                if (done) {
                                    loader.style.display = 'none';
                                    return;
                                }

                                const text = decoder.decode(value);
                                const lines = text.split('\n');

                                for (const line of lines) {
                                    if (line.startsWith('data: ')) {
                                        try {
                                            const data = JSON.parse(line.substring(6));

                                            if (data.status === 'progress') {
                                                addProgressMessage(data.message);
                                            } else if (data.status === 'error') {
                                                addProgressMessage('‚ùå ' + data.message, true);
                                                loader.style.display = 'none';
                                                progressStream.style.display = 'none';
                                                alert('An error occurred: ' + data.message);
                                                return;
                                            } else if (data.status === 'complete') {
                                                addProgressMessage('üéâ ' + data.message);

                                                // Hide progress and loader
                                                loader.style.display = 'none';
                                                setTimeout(() => {
                                                    progressStream.style.display = 'none';
                                                }, 2000);

                                                // Store questions
                                                currentQuestions = data.questions;
                                                currentPdfSummary = data.pdf_summary || null;

                                                // Display summary if available
                                                if (data.summary) {
                                                    displaySummary(data.summary);
                                                }

                                                // Display questions
                                                displayQuestions(currentQuestions);
                                                resultContainer.style.display = 'block';
                                                downloadContainer.style.display = 'block';
                                            }
                                        } catch (e) {
                                            console.log('Parse error:', e, 'Line:', line);
                                        }
                                    }
                                }

                                readStream();
                            }).catch(err => {
                                loader.style.display = 'none';
                                progressStream.style.display = 'none';
                                alert('Stream error: ' + err.message);
                            });
                        }

                        readStream();
                    }).catch(err => {
                        loader.style.display = 'none';
                        progressStream.style.display = 'none';
                        addProgressMessage('‚ùå Error: ' + err.message, true);
                        alert('An error occurred: ' + err.message);
                    });
                } else {
                    // Use XMLHttpRequest for parse/split modes (no streaming needed)
                    const xhr = new XMLHttpRequest();

                    // Show progress bar
                    progressContainer.style.display = 'block';

                    // Track upload progress
                    xhr.upload.addEventListener('progress', function(e) {
                        if (e.lengthComputable) {
                            const percentComplete = (e.loaded / e.total) * 100;
                            const uploadedMB = (e.loaded / (1024 * 1024)).toFixed(2);
                            const totalMB = (e.total / (1024 * 1024)).toFixed(2);

                            progressFill.style.width = percentComplete + '%';
                            progressFill.textContent = Math.round(percentComplete) + '%';
                            progressText.textContent = uploadedMB + ' MB / ' + totalMB + ' MB';
                        }
                    });

                    xhr.addEventListener('load', function() {
                        progressContainer.style.display = 'none';

                        if (xhr.status === 200) {
                            showStatus(extractStatus);
                            const data = JSON.parse(xhr.responseText);

                            if (data.error) {
                                loader.style.display = 'none';
                                document.getElementById('statusMessages').style.display = 'none';
                                alert('An error occurred: ' + data.error);
                                return;
                            }

                            // Hide loader and status messages
                            loader.style.display = 'none';
                            document.getElementById('statusMessages').style.display = 'none';

                            if (mode === 'split') {
                                // Handle split mode response
                                displaySplitResults(data);
                            } else if (mode === 'summarize') {
                                // Handle summarize mode response
                                displaySummaryResults(data);
                            } else {
                                currentQuestions = data.questions;
                                currentPdfSummary = data.pdf_summary || null;

                                // Display summary if available
                                if (data.summary) {
                                    if (mode === 'parse') {
                                        // For parse mode, show a simpler summary
                                        displayParseSummary(data.summary);
                                    } else {
                                        displaySummary(data.summary);
                                    }
                                }

                                // Display questions
                                displayQuestions(currentQuestions);
                                resultContainer.style.display = 'block';
                                downloadContainer.style.display = 'block';
                            }
                        } else {
                            progressContainer.style.display = 'none';
                            loader.style.display = 'none';
                            document.getElementById('statusMessages').style.display = 'none';

                            // Handle specific error codes
                            if (xhr.status === 413) {
                                alert('‚ùå File too large!\n\nThe file exceeds the maximum allowed size.\n\nProduction (Vercel): Maximum 6MB\nLocal: Maximum 500MB\n\nPlease use a smaller PDF or try the local version.');
                            } else {
                                try {
                                    const data = JSON.parse(xhr.responseText);
                                    alert('An error occurred: ' + (data.error || 'Unknown error'));
                                } catch (e) {
                                    alert('An error occurred: ' + xhr.status + ' ' + xhr.statusText);
                                }
                            }
                        }
                    });

                    xhr.addEventListener('error', function() {
                        progressContainer.style.display = 'none';
                        loader.style.display = 'none';
                        document.getElementById('statusMessages').style.display = 'none';
                        alert('An error occurred during upload. Please try again.');
                    });

                    xhr.open('POST', endpoint);
                    xhr.send(formData);
                }
            }
        });
    </script>
</body>
</html>